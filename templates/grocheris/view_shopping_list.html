{% extends 'grocheris/base.html' %}

{% block script %}
{{ add_form.media }}
<script type="text/javascript">
    $(document).ready(function() {
	var options = {
	    url: '{% url add_item %}',
	    dataType: 'json',
	    success: addItemRow,
	    beforeSubmit: beforeForm
	};

	$('#add_item_form').ajaxForm(options);

	$('.item-row, .item-row-nav, .delete').mouseenter(function() {
	    $('.delete, .item-row-nav', this).css('visibility', 'visible');
	}).mouseleave(function() {
	    $('.delete, .item-row-nav, .delete', this).css('visibility', 'hidden');
	});
    });

function addItemRow(data) {
    if (data) {
	row = '<tr><td class="item-row" id="item-' + data['id'] + '" style="display:none;">' +
	    '<div class="delete"><input type="button" value="delete" onClick="deleteItem(' + data['id'] + ');" /></div>' + 
	    '<div class="item-row-nav"><input type="button" value="bought it" onClick="buyItem(' + data['id'] + ');" /></div>' +
	    data['name'] + '</td></tr>';
	$('#item-table > tbody:first').prepend(row);
	$('#item-table td:first').mouseenter(function() {
	    $('.delete, .item-row-nav', this).css('visibility', 'visible');
	}).mouseleave(function() {
	    $('.delete, .item-row-nav, .delete', this).css('visibility', 'hidden');
	});	    
	$('#item-table td:first').fadeIn('fast');
    }
}

function removeItemRow(data) {
    if (data) {
	$('#item-' + data['id']).fadeOut('fast');
    }
}

function buyItem(id) {
    url = '{% url buy item_id=0 %}'.replace('0', id);
    $.post(url,
	   removeItemRow);
}

function beforeForm() {
}
</script>
{% endblock %}

{% block title %}Shopping list{% endblock %}

{% block content %}

<h2>Shopping List</h2>

<div id="add-item" style="margin-top: 10px; margin-bottom: 10px;">
  <form id="add_item_form" method="post">
    {{ add_form }}
    <input type="submit" value="Add Item" />
  </form>
</div>

<table id="item-table">
  {% if items %}
  {% for item in items %}
  <tr><td class="item-row" id="item-{{ item.id }}">
      <div class="delete">
	<input type="button" value="delete" onClick="deleteItem({{ item.id }});" />
      </div>      

      <div class="item-row-nav">
	<input type="button" value="bought it" onClick="buyItem({{ item.id }})" />
      </div>
      
      {{ item }}
  </td></tr>
  {% endfor %}
  {% else %}
  <tr><td></td></tr>
  {% endif %}
</table>
  
{% endblock %}
